<%# app/views/groups/show.html.erb (or whatever this page is) %>

<%= render "status_strip",
      group: @group,
      week: @status_week,
      my_submission: @status_my_submission,
      unread_group: @status_unread_group,
      unread_week: @status_unread_week,
      days_left: @status_days_left %>

<% membership = @group.group_memberships.find_by(user_id: current_user.id) %>
<% is_admin = @group.owner_id == current_user.id || membership&.role.to_s == "admin" %>
<% is_member = membership.present? && membership.status.to_s == "active" %>

<div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-2 mb-3">
  <!-- LEFT: Title / badges / meta -->
  <div class="flex-grow-1" style="min-width: 0;">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <h1 class="h4 mb-1 text-truncate"><%= @group.name %></h1>

      <% if @group.public? %>
      <span class="badge rounded-pill text-bg-success">Public</span>
      <% else %>
      <span class="badge rounded-pill text-bg-secondary">Private</span>
      <% end %>
    </div>

    <div class="text-muted">
      <%= pluralize(@group.members.count, "member") %>
    </div>

    <% if current_user.id == @group.owner_id %>
    <div class="text-muted small mt-1">Owner can’t leave (transfer ownership first)</div>
    <% end %>
  </div>

  <!-- RIGHT: Actions (grid on xs, inline on sm+) -->
  <div class="ms-sm-auto d-grid gap-2 d-sm-flex">
    <% if membership.present? && current_user.id != @group.owner_id %>
    <%= button_to "Leave Group",
            group_membership_path(@group, membership),
            method: :delete,
            data: { turbo_confirm: "Leave #{@group.name}? You can re-join later if it's public." },
            class: "btn btn-outline-danger text-nowrap" %>
    <% end %>

    <% if is_admin %>
    <%= link_to "Manage Group",
            group_manage_path(@group),
            class: "btn btn-outline-primary text-nowrap" %>
    <% end %>

    <%= link_to "Member List", group_members_path(@group),
          class: "btn btn-outline-primary text-nowrap" %>

    <%= link_to "Back to Groups", groups_path,
          class: "btn btn-outline-secondary text-nowrap" %>
  </div>
</div>

<div class="card glass-card p-3">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-3">
    <h2 class="h6 mb-0">Weeks</h2>

    <%# ✅ any active member (including owner/admin) can create a week %>
    <% if current_user.admin? || @group.owner_id == current_user.id || is_member %>
    <%= form_with model: [@group, @group.weeks.new],
                    url: group_weeks_path(@group),
                    method: :post,
                    local: true,
                    class: "w-100" do |f| %>

    <div class="row g-2 align-items-end justify-content-md-end">
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <%= f.label :title, class: "form-label small mb-1" %>
        <%= f.text_field :title, class: "form-control form-control-sm", placeholder: "Week title", required: true %>
      </div>

      <div class="col-12 col-sm-6 col-md-3 col-lg-2">
        <%= f.label :starts_on, "Starts", class: "form-label small mb-1" %>
        <%= f.date_field :starts_on, class: "form-control form-control-sm", required: true %>
      </div>

      <div class="col-12 col-sm-6 col-md-3 col-lg-2">
        <%= f.label :ends_on, "Ends", class: "form-label small mb-1" %>
        <%= f.date_field :ends_on, class: "form-control form-control-sm", required: true %>
      </div>

      <div class="col-12 col-sm-6 col-md-auto">
        <%= f.submit "Create Week", class: "btn btn-sm btn-primary w-100 w-md-auto" %>
      </div>
    </div>

    <% end %>
    <% end %>
  </div>

  <% if @weeks.any? %>
  <div class="list-group">
    <% @weeks.each do |week| %>
    <% unread = @unread_by_week[week.id].to_i %>

    <%= link_to group_week_path(@group, week),
              class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center" do %>

    <div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="fw-semibold"><%= week.title %></span>

        <% if unread > 0 %>
        <span class="badge rounded-pill text-bg-primary"><%= unread %> new</span>
        <% end %>
      </div>

      <div class="small text-muted">
        <%= week.starts_on.strftime("%b %-d") %> – <%= week.ends_on.strftime("%b %-d, %Y") %>
      </div>
    </div>

    <span class="badge bg-secondary"><%= week.status %></span>
    <% end %>
    <% end %>
  </div>
  <% else %>
  <div class="text-muted text-center py-4">
    No weeks yet.
  </div>
  <% end %>
</div>