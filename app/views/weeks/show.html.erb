<div class="container py-4">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="h4 mb-1"><%= @week.title %></h1>
      <div class="text-muted small">
        <%= @week.starts_on %> ‚Äì <%= @week.ends_on %>
        ‚Ä¢ <span class="badge text-bg-<%= @week.open? ? "success" : "secondary" %>"><%= @week.status %></span>
      </div>
    </div>

    <div class="d-flex gap-2">
      <%= link_to "Back to Group", group_path(@group), class: "btn btn-outline-secondary" %>
      <%= link_to "Your Submission", group_week_submission_path(@group, @week), class: "btn btn-primary" %>
    </div>
  </div>

  <% unread_map = (@unread_by_submission_id || {}) %>

  <% if @submissions.blank? %>
  <div class="alert alert-info">
    No submissions yet. Click <strong>Your Submission</strong> to upload up to 3 photos.
  </div>
  <% else %>
  <div class="row g-3">
    <% @submissions.each do |s| %>

    <!-- ‚úÖ CHANGED: was col-12 -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">

          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="fw-semibold"><%= s.user.display_name_or_email %></div>

                <% unread = (unread_map[s.id] || 0) %>
                <% if unread.positive? %>
                <span class="badge rounded-pill text-bg-warning">New (<%= unread %>)</span>
                <% end %>
              </div>

              <% if s.caption.present? %>
              <div class="text-muted small"><%= simple_format(s.caption) %></div>
              <% end %>

              <% if s.feedback_focus.present? %>
              <div class="mt-2">
                <span class="small text-muted me-2 fw-semibold">
                  Wants feedback on:
                </span>

                <% labels = {
                        "composition" => "Composition",
                        "lighting"    => "Lighting",
                        "color"       => "Color",
                        "story"       => "Story / Mood",
                        "editing"     => "Editing / Post"
                      } %>

                <% s.feedback_focus.each do |key| %>
                <% next if key.blank? %>
                <span class="badge text-bg-light border me-1">
                  <%= labels[key] || key.to_s.humanize %>
                </span>
                <% end %>
              </div>
              <% end %>
            </div>

            <% counts = s.votes.group(:photo_index).count %>
            <div class="text-muted small text-end">
              Votes:
              <% (0..2).each do |i| %>
              <span class="ms-2">P<%= i + 1 %>: <%= counts[i] || 0 %></span>
              <% end %>
            </div>
          </div>

          <hr>

          <div class="d-flex flex-column gap-3">
            <% your_vote = s.votes.detect { |v| v.user_id == current_user.id } %>

            <% s.photos.each_with_index do |photo, idx| %>
            <% photo_comments =
      s.comments
        .select { |c| c.photo_index == idx && c.parent_id.nil? }
        .sort_by(&:created_at) %>

            <% collapse_id = "photoComments#{s.id}_#{idx}" %>

            <div class="card">
              <!-- Photo full-width -->
              <a href="#" data-photo-lightbox data-full-url="<%= url_for(photo) %>" class="d-block">
                <%= image_tag url_for(photo),
              class: "img-fluid rounded-top",
              style: "width:100%; height:auto; display:block;" %>
              </a>

              <div class="card-body">
                <!-- Header row: Photo label + vote + toggle comments -->
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                  <div class="small text-muted">Photo <%= idx + 1 %></div>

                  <div class="d-flex align-items-center gap-2">
                    <%= form_with url: submission_vote_path(s), method: :post, local: true do %>
                    <%= hidden_field_tag "vote[photo_index]", idx %>
                    <%= submit_tag(
                    (your_vote&.photo_index == idx ? "Voted" : "Vote"),
                    class: "btn btn-sm #{your_vote&.photo_index == idx ? "btn-success" : "btn-outline-primary"}"
                  ) %>
                    <% end %>

                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#<%= collapse_id %>" aria-expanded="false" aria-controls="<%= collapse_id %>">
                      Critique (<%= photo_comments.size %>)
                    </button>
                  </div>
                </div>

                <!-- Collapsible comments -->
                <div class="collapse" id="<%= collapse_id %>">
                  <% if photo_comments.any? %>
                  <div class="mb-3">
                    <% photo_comments.each do |c| %>
                    <div class="border rounded p-2 mb-2">

                      <div class="d-flex justify-content-between align-items-start">
                        <div class="small text-muted mb-1">
                          <%= c.user&.display_name_or_email || "Deleted user" %>
                        </div>
                        <div class="small text-muted">
                          <%= time_ago_in_words(c.created_at) %> ago
                        </div>
                      </div>

                      <div><%= simple_format(c.body) %></div>

                      <%# ---- CONSOLIDATED KUDOS ---- %>
                      <% my_kudos = c.comment_kudos.select { |k| k.user_id == current_user.id }.map(&:kind) %>
                      <% counts_by_kind = c.comment_kudos.group_by(&:kind).transform_values(&:size) %>

                      <% helpful = counts_by_kind["helpful"] || 0 %>
                      <% insightful = counts_by_kind["insightful"] || 0 %>
                      <% encouraging = counts_by_kind["encouraging"] || 0 %>

                      <div class="mt-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="small text-muted">
                          Kudos:
                          <span class="me-2">üëç <%= helpful %></span>
                          <span class="me-2">üéØ <%= insightful %></span>
                          <span>‚ù§Ô∏è <%= encouraging %></span>
                        </div>

                        <% dropdown_id = "kudosDrop#{c.id}" %>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="<%= dropdown_id %>" data-bs-toggle="dropdown" aria-expanded="false">
                            Kudos
                          </button>

                          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="<%= dropdown_id %>">
                            <% [
                          ["helpful", "üëç Helpful"],
                          ["insightful", "üéØ Insightful"],
                          ["encouraging", "‚ù§Ô∏è Encouraging"]
                        ].each do |kind, label| %>

                            <% active = my_kudos.include?(kind) %>

                            <li class="px-2 py-1">
                              <% if active %>
                              <%= button_to "‚úì #{label} (remove)",
                                    submission_comment_kudo_path(s, c, kind: kind),
                                    method: :delete,
                                    class: "btn btn-sm btn-outline-danger w-100 text-start" %>
                              <% else %>
                              <%= button_to "#{label} (give)",
                                    submission_comment_comment_kudos_path(s, c),
                                    method: :post,
                                    params: { kind: kind },
                                    class: "btn btn-sm btn-outline-secondary w-100 text-start" %>
                              <% end %>
                            </li>
                            <% end %>
                          </ul>
                        </div>
                      </div>
                    </div>
                    <% end %>
                  </div>
                  <% else %>
                  <div class="text-muted small mb-2">No critiques yet.</div>
                  <% end %>
                </div>

                <!-- Always-visible add critique -->
                <%= form_with url: submission_comments_path(s), method: :post, local: true do %>
                <%= hidden_field_tag "comment[photo_index]", idx %>
                <div class="input-group">
                  <%= text_field_tag "comment[body]", nil,
                  class: "form-control",
                  placeholder: "Add a critique‚Ä¶" %>
                  <%= submit_tag "Post", class: "btn btn-outline-secondary" %>
                </div>
                <% end %>
              </div>
            </div>
            <% end %>
          </div>

        </div>
      </div>
    </div>

    <% end %>
  </div>
  <% end %>
</div>