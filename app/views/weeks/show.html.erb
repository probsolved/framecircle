<div class="container py-4">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="h4 mb-1"><%= @week.title %></h1>
      <div class="text-muted small">
        <%= @week.starts_on %> – <%= @week.ends_on %>
        • <span class="badge text-bg-<%= @week.open? ? "success" : "secondary" %>"><%= @week.status %></span>
      </div>
    </div>

    <div class="d-flex gap-2">
      <%= link_to "Back to Group", group_path(@group), class: "btn btn-outline-secondary" %>
      <%= link_to "Your Submission", group_week_submission_path(@group, @week), class: "btn btn-primary" %>
    </div>
  </div>

  <% if @submissions.blank? %>
  <div class="alert alert-info">
    No submissions yet. Click <strong>Your Submission</strong> to upload up to 3 photos.
  </div>
  <% else %>
  <div class="row g-3">
    <% @submissions.each do |s| %>
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold"><%= s.user.display_name_or_email %></div>
              <% if s.caption.present? %>
              <div class="text-muted small"><%= simple_format(s.caption) %></div>
              <% end %>
            </div>

            <% counts = s.votes.group(:photo_index).count %>
            <div class="text-muted small">
              Votes:
              <% (0..2).each do |i| %>
              <span class="ms-2">P<%= i + 1 %>: <%= counts[i] || 0 %></span>
              <% end %>
            </div>
          </div>

          <hr>

          <div class="row g-2">
            <% your_vote = s.votes.detect { |v| v.user_id == current_user.id } %>

            <% s.photos.each_with_index do |photo, idx| %>
            <div class="col-12 col-md-4">
              <div class="card h-100">
                <a href="#" data-photo-lightbox data-full-url="<%= url_for(photo) %>" class="d-block">
                  <%= image_tag url_for(photo), class: "img-fluid rounded-top" %>
                </a>

                <div class="card-body py-2">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="small text-muted">Photo <%= idx + 1 %></div>

                    <%= form_with url: submission_vote_path(s), method: :post, local: true do %>
                    <%= hidden_field_tag "vote[photo_index]", idx %>
                    <%= submit_tag(
                                  (your_vote&.photo_index == idx ? "Voted" : "Vote"),
                                  class: "btn btn-sm #{your_vote&.photo_index == idx ? "btn-success" : "btn-outline-primary"}"
                                ) %>
                    <% end %>
                  </div>

                  <% photo_comments = s.comments.select { |c| c.photo_index == idx && c.parent_id.nil? }.sort_by(&:created_at) %>

                  <% if photo_comments.any? %>
                  <div class="mb-2">
                    <% photo_comments.each do |c| %>
                    <div class="border rounded p-2 mb-2">
                      <div class="small text-muted mb-1"><%= c.user.display_name_or_email %></div>
                      <div><%= simple_format(c.body) %></div>
                    </div>
                    <% end %>
                  </div>
                  <% end %>

                  <%= form_with url: submission_comments_path(s), method: :post, local: true do %>
                  <%= hidden_field_tag "comment[photo_index]", idx %>
                  <div class="input-group">
                    <%= text_field_tag "comment[body]", nil,
                                  class: "form-control",
                                  placeholder: "Add a critique…" %>
                    <%= submit_tag "Post", class: "btn btn-outline-secondary" %>
                  </div>
                  <% end %>

                </div>
              </div>
            </div>
            <% end %>
          </div>

        </div>
      </div>
    </div>
    <% end %>
  </div>
  <% end %>
</div>