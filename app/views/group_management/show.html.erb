<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-1"><%= @group.name %></h1>
      <div class="text-muted small">Manage Group</div>
    </div>

    <div class="d-flex gap-2">
      <%= link_to "Back", group_path(@group), class: "btn btn-outline-secondary" %>

      <%= button_to "Create Invite Link",
            group_invitations_path(group_slug: @group.slug),
            method: :post,
            class: "btn btn-primary" %>
    </div>
  </div>

  <% if flash[:notice].present? %>
  <div class="alert alert-success"><%= flash[:notice] %></div>
  <% end %>
  <% if flash[:alert].present? %>
  <div class="alert alert-warning"><%= flash[:alert] %></div>
  <% end %>

  <!-- MEMBERS -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">Members</h2>

      <% if @memberships.any? %>
      <div class="list-group">
        <% @memberships.each do |membership| %>
        <% user = membership.user %>

        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-semibold"><%= user&.display_name_or_email || user&.email || "Deleted user" %></div>
            <div class="text-muted small">
              Role: <%= membership.respond_to?(:role) ? membership.role : "member" %>
              <% if membership.respond_to?(:status) %>
              • Status: <%= membership.status %>
              <% end %>
            </div>
          </div>

          <% if user && user.id != @group.owner_id %>
          <%= button_to "Remove",
                      group_membership_path(@group, membership),
                      method: :delete,
                      data: { turbo_confirm: "Remove this member from the group?" },
                      class: "btn btn-sm btn-outline-danger" %>
          <% else %>
          <span class="badge text-bg-secondary">Owner</span>
          <% end %>
        </div>
        <% end %>
      </div>
      <% else %>
      <p class="text-muted mb-0">No members yet.</p>
      <% end %>
    </div>
  </div>

  <!-- INVITES -->
  <div class="card">
    <div class="card-body">
      <h2 class="h5 mb-3">Invite Links</h2>

      <% if @invitations.present? %>
      <div class="list-group">
        <% @invitations.each do |inv| %>
        <% url = invitation_url(inv) %>

        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="small text-muted">
              Created <%= time_ago_in_words(inv.created_at) %> ago
              <% if inv.respond_to?(:accepted_at) && inv.accepted_at.present? %>
              • <span class="badge text-bg-success">Accepted</span>
              <% end %>
            </div>

            <div class="small text-muted">
              ID: <%= inv.id %>
            </div>
          </div>

          <div class="mt-2">
            <code class="d-block">
              <%= link_to url, url, target: "_blank", rel: "noopener" %>
            </code>
          </div>
        </div>
        <% end %>
      </div>
      <% else %>
      <p class="text-muted mb-0">No invite links yet.</p>
      <% end %>
    </div>
  </div>

</div>

<!-- DANGER ZONE -->
<% can_delete_group = (user_signed_in? && (current_user.admin? || current_user.id == @group.owner_id)) %>
<% if can_delete_group %>
<div class="card border-danger">
  <div class="card-body">
    <h2 class="h5 text-danger mb-2">Danger Zone</h2>
    <div class="text-muted small mb-3">
      Deleting a group permanently removes the group and all associated data (weeks, submissions, comments, votes, memberships, and invites).
    </div>

    <%= button_to "Delete Group",
              group_path(@group),
              method: :delete,
              data: { turbo_confirm: "Delete #{@group.name}? This cannot be undone." },
              class: "btn btn-danger" %>
  </div>
</div>
<% end %>
</div>